
{{ $src := (.Get "src") }}

{{ $alt := (.Get "alt") }}
{{ $caption := (.Get "caption") }}
{{ $fileName := index (last 1 (split $src "/")) 0 }}
{{ $imageName := index (split $fileName ".") 0 }}
{{ $section := replace $src (printf "/%s" $fileName) "" }}

{{ with .Site.GetPage "section" $section }}

  {{ $original := .Resources.GetMatch (printf "%s*" ($imageName)) }}

  {{ if gt $original.Width 320 }}
    {{ $.Scratch.Set "resize_320" ($original.Resize "320x") }}
  {{ else }}
    {{ $.Scratch.Set "resize_320" ($original) }}
  {{ end }}

  {{ if gt ($original.Width) 480 }}
    {{ $.Scratch.Set "resize_480" ($original.Resize "480x") }}
  {{ else }}
    {{ $.Scratch.Set "resize_480" ($original) }}
  {{ end }}

  {{ if gt ($original.Width) 768 }}
    {{ $.Scratch.Set "resize_768" ($original.Resize "768x") }}
  {{ else }}
    {{ $.Scratch.Set "resize_768" ($original) }}
  {{ end }}

  {{ if gt ($original.Width) 1024 }}
    {{ $.Scratch.Set "resize_1024" ($original.Resize "1024x") }}
  {{ else }}
    {{ $.Scratch.Set "resize_1024" ($original) }}
  {{ end }}

  {{ if gt ($original.Width) 1280 }}
    {{ $.Scratch.Set "resize_1280" ($original.Resize "1280x") }}
  {{ else }}
    {{ $.Scratch.Set "resize_1280" ($original) }}
  {{ end }}

  {{ if gt ($original.Width) 1440 }}
    {{ $.Scratch.Set "resize_1440" ($original.Resize "1440x") }}
  {{ else }}
    {{ $.Scratch.Set "resize_1440" ($original) }}
  {{ end }}

  {{ if gt ($original.Width) 1920 }}
    {{ $.Scratch.Set "resize_1920" ($original.Resize "1920x") }}
  {{ else }}
    {{ $.Scratch.Set "resize_1920" ($original) }}
  {{ end }}

  {{ if $caption }}
  <figure>
  {{ end }}
      <img
        {{ if $alt }}alt="{{ $alt }}"{{ end }}
        loading=lazy
        src="{{ $original.RelPermalink }}"
        srcset="
          {{ ($.Scratch.Get "resize_320").RelPermalink }} 320w,
          {{ ($.Scratch.Get "resize_480").RelPermalink }} 480w,
          {{ ($.Scratch.Get "resize_768").RelPermalink }} 768w,
          {{ ($.Scratch.Get "resize_1024").RelPermalink }} 1024w,
          {{ ($.Scratch.Get "resize_1280").RelPermalink }} 1280w,
          {{ ($.Scratch.Get "resize_1440").RelPermalink }} 1440w,
          {{ ($.Scratch.Get "resize_1920").RelPermalink }} 1920w
        ">
    {{ if $caption }}<figcaption>{{ $caption }}</figcaption>
    </figure>
    {{ end }}

  {{ $.Scratch.Delete "resize_320" }}
  {{ $.Scratch.Delete "resize_480" }}
  {{ $.Scratch.Delete "resize_768" }}
  {{ $.Scratch.Delete "resize_1024" }}
  {{ $.Scratch.Delete "resize_1280" }}
  {{ $.Scratch.Delete "resize_1440" }}
  {{ $.Scratch.Delete "resize_1920" }}

{{ end }}
